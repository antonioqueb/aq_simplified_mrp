<templates id="template" xml:space="preserve">
  <t t-name="aq_simplified_mrp.Main">
    <div class="o_smrp o_smrp--tablet">

      <!-- Nav superior -->
      <div class="o_smrp_nav">
        <button class="o_smrp_nav_btn" 
                t-att-class="{'active': state.view === 'create'}"
                t-on-click="() => this.showCreate()">â• Nueva orden</button>
        <button class="o_smrp_nav_btn" 
                t-att-class="{'active': state.view === 'list' || state.view === 'detail'}"
                t-on-click="() => this.showList()">ğŸ“‹ Mis Ã³rdenes</button>
      </div>

      <!-- WRAPPER PRINCIPAL -->
      <div class="o_smrp_wrapper">

        <!-- ========== VISTA CREAR ========== -->
        <t t-if="state.view === 'create'">
          
          <!-- Barra de progreso simplificada -->
          <div class="o_smrp_progress_bar">
            <div class="o_smrp_progress_track">
              <div class="o_smrp_progress_fill" t-att-style="this.getProgressWidth()"></div>
            </div>
            <div class="o_smrp_step_title"><t t-esc="this.getCurrentStepTitle()"/></div>
          </div>

          <!-- PASO 1: ALMACÃ‰N -->
          <t t-if="state.step === 'warehouse'">
            <div class="o_smrp_container o_smrp_section">
              <h2>Selecciona almacÃ©n</h2>
              <div class="o_smrp_cards o_smrp_cards--center">
                <t t-foreach="state.warehouses" t-as="w" t-key="w.id">
                  <div class="o_smrp_card o_smrp_card--large selectable" t-on-click="() => this.selectWarehouse(w.id)">
                    <div class="o_smrp_card_icon">ğŸ¬</div>
                    <div class="o_smrp_card_title"><t t-esc="w.name"/></div>
                    <div class="o_smrp_card_sub" t-if="w.code"><t t-esc="w.code"/></div>
                  </div>
                </t>
              </div>
              <div class="o_smrp_empty" t-if="!state.warehouses.length">
                <div class="o_smrp_empty_icon">ğŸ“¦</div>
                <div class="o_smrp_empty_text">Sin almacenes disponibles</div>
              </div>
            </div>
          </t>

          <!-- PASO 2: PRODUCTO (Split View) -->
          <t t-if="state.step === 'product'">
            <div class="o_smrp_split_screen">
              
              <!-- Lado izquierdo: CatÃ¡logo -->
              <div class="o_smrp_left_pane">
                <div class="o_smrp_search_bar_wrapper">
                  <span class="o_smrp_search_icon">ğŸ”</span>
                  <input class="o_smrp_clean_input" type="text" placeholder="Â¿QuÃ© vamos a fabricar hoy?"
                         t-model="state.productQuery" t-on-input="() => this.searchProducts()"/>
                </div>

                <div class="o_smrp_grid_scrollable">
                  <t t-foreach="state.products" t-as="p" t-key="p.id">
                    <div class="o_smrp_visual_card" 
                         t-att-class="{'is_active': state.productId === p.id}"
                         t-on-click="() => this.selectProduct(p)">
                      <div class="o_smrp_visual_icon">ğŸ“¦</div>
                      <div class="o_smrp_visual_name"><t t-esc="p.name"/></div>
                      <div class="o_smrp_visual_uom"><t t-esc="p.uom_name || p.uomName"/></div>
                      <div class="o_smrp_visual_check">âœ“</div>
                    </div>
                  </t>
                  <div class="o_smrp_empty" t-if="!state.products.length">
                    <div class="o_smrp_empty_icon">ğŸ”</div>
                    <div class="o_smrp_empty_text">Sin resultados</div>
                  </div>
                </div>
              </div>

              <!-- Lado derecho: Panel de acciÃ³n -->
              <div class="o_smrp_right_pane" t-att-class="{'is_ready': state.productId}">
                <div class="o_smrp_selection_summary">
                  <t t-if="state.productName">
                    <div class="o_smrp_summary_label">Seleccionado:</div>
                    <h2 class="o_smrp_summary_title"><t t-esc="state.productName"/></h2>
                    
                    <div class="o_smrp_summary_qty_input">
                      <label>Cantidad a producir</label>
                      <div class="o_smrp_qty_control">
                        <button class="o_smrp_btn_qty" t-on-click="() => this.decreaseQty()">âˆ’</button>
                        <input type="number" class="o_smrp_input_huge" t-model="state.qty" min="0" step="0.01"/>
                        <button class="o_smrp_btn_qty" t-on-click="() => this.increaseQty()">+</button>
                      </div>
                      <span class="o_smrp_unit_badge"><t t-esc="state.uomName"/></span>
                    </div>
                  </t>
                  <t t-else="">
                    <div class="o_smrp_empty_state_msg">
                      <div class="o_smrp_empty_icon">ğŸ‘ˆ</div>
                      <div>Selecciona un producto</div>
                    </div>
                  </t>
                </div>

                <button class="o_smrp_big_cta"
                        t-att-disabled="!state.productId || this.toNum(state.qty) &lt;= 0"
                        t-on-click="() => this.confirmProductAndQty()">
                  Siguiente Paso â†’
                </button>
              </div>

            </div>
          </t>

          <!-- PASO 3: COMPONENTES (Split View) -->
          <t t-if="state.step === 'components'">
            <div class="o_smrp_split_screen">
              
              <!-- Lado izquierdo: BÃºsqueda y agregar -->
              <div class="o_smrp_left_pane">
                <t t-if="!state.editingComponent">
                  <div class="o_smrp_search_bar_wrapper">
                    <span class="o_smrp_search_icon">ğŸ”</span>
                    <input class="o_smrp_clean_input" type="text" placeholder="Buscar ingrediente..."
                           t-model="state.compSearchQuery" t-on-input="() => this.searchComponents()"/>
                  </div>

                  <div class="o_smrp_grid_scrollable">
                    <t t-foreach="state.compSearchResults" t-as="p" t-key="p.id">
                      <div class="o_smrp_visual_card" t-on-click="() => this.addComponentFromSearch(p)">
                        <div class="o_smrp_visual_icon">â•</div>
                        <div class="o_smrp_visual_name"><t t-esc="p.name"/></div>
                        <div class="o_smrp_visual_uom"><t t-esc="p.uom_name"/></div>
                      </div>
                    </t>
                    <div class="o_smrp_empty" t-if="!state.compSearchResults.length &amp;&amp; state.compSearchQuery">
                      <div class="o_smrp_empty_icon">ğŸ”</div>
                      <div class="o_smrp_empty_text">Sin coincidencias</div>
                    </div>
                  </div>
                </t>

                <!-- Wizard de ediciÃ³n -->
                <t t-if="state.editingComponent &amp;&amp; state.components.length">
                  <div class="o_smrp_wizard_full">
                    <div class="o_smrp_wizard_counter">Ingrediente <t t-esc="state.compIndex + 1"/> de <t t-esc="state.components.length"/></div>
                    <t t-set="c" t-value="state.components[state.compIndex]"/>
                    <div class="o_smrp_wizard_card">
                      <div class="o_smrp_wizard_icon">ğŸ§ª</div>
                      <h3 class="o_smrp_wizard_title"><t t-esc="c.name"/></h3>
                      <div class="o_smrp_wizard_meta">UM: <t t-esc="c.uom_name"/></div>
                      
                      <div class="o_smrp_qty_control_vertical">
                        <label>Cantidad requerida</label>
                        <div class="o_smrp_qty_control">
                          <button class="o_smrp_btn_qty" t-on-click="() => this.decreaseCompQty()">âˆ’</button>
                          <input class="o_smrp_input_huge" type="number" min="0" step="0.0001"
                                 t-att-value="c.qty_required" t-on-input="(ev) => this.updateCurrentQty(ev)"/>
                          <button class="o_smrp_btn_qty" t-on-click="() => this.increaseCompQty()">+</button>
                        </div>
                      </div>

                      <div class="o_smrp_wizard_actions">
                        <button class="o_smrp_btn o_smrp_btn--danger" t-on-click="() => this.removeCurrentComponent()">
                          ğŸ—‘ï¸ Eliminar
                        </button>
                        <button class="o_smrp_btn o_smrp_btn--ghost" 
                                t-att-disabled="state.compIndex === 0" 
                                t-on-click="() => this.prevComponent()">
                          â† Anterior
                        </button>
                        <button class="o_smrp_btn o_smrp_btn--primary" t-on-click="() => this.nextComponent()">
                          <t t-if="state.compIndex &lt; state.components.length - 1">Siguiente â†’</t>
                          <t t-else="">âœ“ Listo</t>
                        </button>
                      </div>
                    </div>
                  </div>
                </t>
              </div>

              <!-- Lado derecho: Resumen de ingredientes -->
              <div class="o_smrp_right_pane o_smrp_right_pane--ingredients">
                <div class="o_smrp_summary_label">Ingredientes agregados</div>
                <div class="o_smrp_ingredients_list">
                  <t t-foreach="state.components" t-as="comp" t-key="comp_index">
                    <div class="o_smrp_ingredient_item" 
                         t-att-class="{'is_current': state.editingComponent &amp;&amp; state.compIndex === comp_index}"
                         t-on-click="() => this.editComponent(comp_index)">
                      <div class="o_smrp_ingredient_name"><t t-esc="comp.name"/></div>
                      <div class="o_smrp_ingredient_qty">
                        <strong><t t-esc="comp.qty_required"/></strong> <t t-esc="comp.uom_name"/>
                      </div>
                    </div>
                  </t>
                  <div class="o_smrp_empty" t-if="!state.components.length">
                    <div class="o_smrp_empty_icon">ğŸ§ª</div>
                    <div class="o_smrp_empty_text">Sin ingredientes</div>
                  </div>
                </div>

                <button class="o_smrp_big_cta"
                        t-att-disabled="!state.components.length"
                        t-on-click="() => this.continueToLots()">
                  Continuar a lotes â†’
                </button>
              </div>

            </div>
          </t>

          <!-- PASO 4: LOTES -->
          <t t-if="state.step === 'lots'">
            <div class="o_smrp_container o_smrp_section">
              <t t-if="state.components.length">
                <div class="o_smrp_wizard">
                  <div class="o_smrp_wizard_counter">Ingrediente <t t-esc="state.compIndex + 1"/> de <t t-esc="state.components.length"/></div>
                  <t t-set="c" t-value="state.components[state.compIndex]"/>
                  <div class="o_smrp_wizard_card">
                    <div class="o_smrp_wizard_icon">ğŸ§ª</div>
                    <h3 class="o_smrp_wizard_title"><t t-esc="c.name"/></h3>
                    <div class="o_smrp_wizard_meta">Requerido: <strong><t t-esc="c.qty_required"/></strong> <t t-esc="c.uom_name"/></div>
                    
                    <div class="o_smrp_lots_grid">
                      <t t-foreach="state.lots" t-as="l" t-key="l.id">
                        <div class="o_smrp_lot_card" 
                             t-att-class="{'is_selected': state.chosenLots &amp;&amp; state.chosenLots[c.product_id] === l.id}"
                             t-on-click="() => this.chooseLot(l.id)">
                          <div class="o_smrp_lot_name"><t t-esc="l.name"/></div>
                          <div class="o_smrp_lot_qty"><strong><t t-esc="l.qty_available"/></strong> disponible</div>
                          <div class="o_smrp_lot_check">âœ“</div>
                        </div>
                      </t>
                      <div class="o_smrp_empty" t-if="!state.lots.length">
                        <div class="o_smrp_empty_icon">ğŸ“¦</div>
                        <div class="o_smrp_empty_text">Sin lotes con stock</div>
                      </div>
                    </div>
                  </div>
                </div>
              </t>
            </div>
            
            <!-- Footer sticky para lotes -->
            <div class="o_smrp_footer_sticky">
              <button class="o_smrp_btn o_smrp_btn--ghost o_smrp_btn--large" t-on-click="() => this.prevLot()">
                <t t-if="state.compIndex === 0">â† Ingredientes</t>
                <t t-else="">â† Anterior</t>
              </button>
              <button class="o_smrp_btn o_smrp_btn--primary o_smrp_btn--large" 
                      t-att-disabled="!(state.chosenLots &amp;&amp; state.chosenLots[state.components[state.compIndex].product_id])"
                      t-on-click="() => this.nextLot()">
                <t t-if="state.compIndex &lt; state.components.length - 1">Siguiente â†’</t>
                <t t-else="">âœ“ Crear orden</t>
              </button>
            </div>
          </t>

          <!-- PASO 5: DONE -->
          <t t-if="state.step === 'done'">
            <div class="o_smrp_container o_smrp_section o_smrp_done">
              <div class="o_smrp_done_icon">ğŸ‰</div>
              <h2>Â¡Orden creada!</h2>
              <div class="o_smrp_done_text">El proceso se completÃ³ correctamente</div>
              <button class="o_smrp_big_cta" t-on-click="() => this.resetWizard()">Crear nueva orden</button>
            </div>
          </t>
        </t>

        <!-- ========== VISTA LISTA ========== -->
        <t t-if="state.view === 'list'">
          <div class="o_smrp_container o_smrp_section">
            <h2>Mis Ã³rdenes de producciÃ³n</h2>
            <div class="o_smrp_list">
              <t t-foreach="state.myProductions" t-as="mo" t-key="mo.id">
                <div class="o_smrp_list_item" t-on-click="() => this.loadMoDetail(mo.id)">
                  <div class="o_smrp_list_icon">ğŸ“¦</div>
                  <div class="o_smrp_list_content">
                    <div class="o_smrp_list_title"><t t-esc="mo.name"/></div>
                    <div class="o_smrp_list_meta">
                      <t t-esc="mo.product_name"/> â€¢ <strong><t t-esc="mo.product_qty"/></strong> <t t-esc="mo.uom_name"/>
                    </div>
                  </div>
                  <div class="o_smrp_list_badge" t-att-class="this.getStateClass(mo.state)">
                    <t t-esc="this.getStateLabel(mo.state)"/>
                  </div>
                </div>
              </t>
            </div>
            <div class="o_smrp_empty" t-if="!state.myProductions.length">
              <div class="o_smrp_empty_icon">ğŸ“‹</div>
              <div class="o_smrp_empty_text">No tienes Ã³rdenes de producciÃ³n</div>
            </div>
          </div>
        </t>

        <!-- ========== VISTA DETALLE ========== -->
        <t t-if="state.view === 'detail' &amp;&amp; state.moDetail">
          <div class="o_smrp_container o_smrp_section">
            <button class="o_smrp_btn o_smrp_btn--ghost" t-on-click="() => this.backToList()">â† Volver</button>

            <h2><t t-esc="state.moDetail.name"/></h2>
            
            <div class="o_smrp_detail_box">
              <div class="o_smrp_detail_row">
                <span class="o_smrp_detail_label">Estado:</span>
                <span class="o_smrp_list_badge" t-att-class="this.getStateClass(state.moDetail.state)">
                  <t t-esc="this.getStateLabel(state.moDetail.state)"/>
                </span>
              </div>
              <div class="o_smrp_detail_row">
                <span class="o_smrp_detail_label">Producto:</span>
                <strong><t t-esc="state.moDetail.product_name"/></strong>
              </div>
              <div class="o_smrp_detail_row">
                <span class="o_smrp_detail_label">Cantidad:</span>
                <strong><t t-esc="state.moDetail.product_qty"/></strong> <t t-esc="state.moDetail.uom_name"/>
              </div>
              <div class="o_smrp_detail_row" t-if="state.moDetail.finished_lot">
                <span class="o_smrp_detail_label">Lote terminado:</span>
                <t t-esc="state.moDetail.finished_lot"/>
              </div>
            </div>

            <h2>Ingredientes</h2>
            <div class="o_smrp_list">
              <t t-foreach="state.moDetail.components" t-as="comp" t-key="comp_index">
                <div class="o_smrp_list_item">
                  <div class="o_smrp_list_icon">ğŸ§ª</div>
                  <div class="o_smrp_list_content">
                    <div class="o_smrp_list_title"><t t-esc="comp.product_name"/></div>
                    <div class="o_smrp_list_meta">
                      <strong><t t-esc="comp.qty_required"/></strong> <t t-esc="comp.uom_name"/>
                      <t t-if="comp.lot_name"> â€¢ Lote: <t t-esc="comp.lot_name"/></t>
                    </div>
                  </div>
                </div>
              </t>
            </div>
          </div>
        </t>

      </div>

    </div>
  </t>
</templates>