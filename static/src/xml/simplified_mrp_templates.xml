<templates id="template" xml:space="preserve">
  <t t-name="aq_simplified_mrp.Main">
    <div class="o_smrp o_smrp--tablet">

      <!-- Nav superior -->
      <div class="o_smrp_nav">
        <button class="o_smrp_nav_btn" t-att-class="{'active': state.view === 'create'}" t-on-click="() => this.showCreate()">‚ûï Nueva orden</button>
        <button class="o_smrp_nav_btn" t-att-class="{'active': state.view === 'list' || state.view === 'detail'}" t-on-click="() => this.showList()">üìã Mis √≥rdenes</button>
      </div>

      <!-- WRAPPER PRINCIPAL -->
      <div class="o_smrp_wrapper">

        <!-- ========== VISTA CREAR ========== -->
        <t t-if="state.view === 'create'">
          <!-- Steps Header -->
          <div class="o_smrp_container">
            <ol class="o_smrp_steps" role="list">
              <li t-att-class="{'active': state.step === 'warehouse', 'done': ['product','components','lots','done'].includes(state.step)}">
                <span class="num">1</span><span>Almac√©n</span>
              </li>
              <li t-att-class="{'active': state.step === 'product', 'done': ['components','lots','done'].includes(state.step)}">
                <span class="num">2</span><span>Configuraci√≥n</span>
              </li>
              <li t-att-class="{'active': state.step === 'components', 'done': ['lots','done'].includes(state.step)}">
                <span class="num">3</span><span>Ingredientes</span>
              </li>
              <li t-att-class="{'active': state.step === 'lots', 'done': ['done'].includes(state.step)}">
                <span class="num">4</span><span>Lotes</span>
              </li>
              <li t-att-class="{'active': state.step === 'done'}">
                <span class="num">5</span><span>Listo</span>
              </li>
            </ol>
          </div>

          <!-- PASO 1: ALMAC√âN -->
          <t t-if="state.step === 'warehouse'">
            <div class="o_smrp_container o_smrp_section">
              <h2>Selecciona almac√©n</h2>
              <div class="o_smrp_cards o_smrp_cards--center">
                <t t-foreach="state.warehouses" t-as="w" t-key="w.id">
                  <div class="o_smrp_card selectable" t-on-click="() => this.selectWarehouse(w.id)">
                    <div class="o_smrp_card_icon">üè¨</div>
                    <div class="o_smrp_card_title"><t t-esc="w.name"/></div>
                    <div class="o_smrp_card_sub" t-if="w.code"><t t-esc="w.code"/></div>
                  </div>
                </t>
              </div>
            </div>
          </t>

          <!-- PASO 2: PRODUCTO Y CONFIG -->
          <t t-if="state.step === 'product'">
            <div class="o_smrp_container o_smrp_section">
              <h2>Producto y Origen</h2>
              <div class="o_smrp_box">
                <!-- Buscador Producto -->
                <div class="o_smrp_row">
                  <div class="o_smrp_field_group">
                    <label class="o_smrp_label">Producto a fabricar</label>
                    <input class="o_smrp_input o_smrp_input--xl" type="text" placeholder="Buscar..."
                           t-model="state.productQuery" t-on-input="() => this.searchProducts()"/>
                  </div>
                  <div class="o_smrp_field_group">
                     <label class="o_smrp_label">Cantidad</label>
                     <input class="o_smrp_input o_smrp_input--xl" type="number" min="0" step="0.01"
                            t-model="state.qty" placeholder="1.0"/>
                  </div>
                </div>

                <!-- Selectores Adicionales -->
                <div class="o_smrp_row" style="margin-top:10px;">
                    <div class="o_smrp_field_group">
                        <label class="o_smrp_label">Origen (Venta)</label>
                        <select class="o_smrp_input" t-model="state.selectedSaleOrder">
                            <option value="">-- Sin origen espec√≠fico --</option>
                            <t t-foreach="state.saleOrders" t-as="so" t-key="so.id">
                                <option t-att-value="so"><t t-esc="so.name"/></option>
                            </t>
                        </select>
                    </div>
                    <div class="o_smrp_field_group">
                        <label class="o_smrp_label">Destino (Ubicaci√≥n)</label>
                        <select class="o_smrp_input" t-model="state.selectedDestLocation">
                            <option value="">-- Por defecto (Stock) --</option>
                            <t t-foreach="state.destLocations" t-as="loc" t-key="loc.id">
                                <option t-att-value="loc"><t t-esc="loc.name"/></option>
                            </t>
                        </select>
                    </div>
                </div>

                <div class="o_smrp_actions o_smrp_actions--end">
                   <button class="o_smrp_btn confirm o_smrp_btn--xl"
                          t-att-disabled="!(state.productId &amp;&amp; this.toNum(state.qty) > 0)"
                          t-on-click="() => this.confirmProductAndConfig()">Siguiente</button>
                </div>
              </div>

              <!-- Lista Resultados Productos -->
              <div class="o_smrp_cards o_smrp_cards--center" style="margin-top:16px;">
                <t t-foreach="state.products" t-as="p" t-key="p.id">
                  <div class="o_smrp_card selectable" t-att-class="{'selected': state.productId === p.id}"
                       t-on-click="() => this.selectProduct(p)">
                    <div class="o_smrp_card_icon">üì¶</div>
                    <div class="o_smrp_card_title"><t t-esc="p.name"/></div>
                    <div class="o_smrp_card_sub"><t t-esc="p.uom_name || p.uomName"/></div>
                    <div class="o_smrp_check">‚úî</div>
                  </div>
                </t>
              </div>

              <div class="o_smrp_selected" t-if="state.productName">
                <span class="badge">Seleccionado</span>
                <strong><t t-esc="state.productName"/></strong>
                <t t-if="state.qty"> ‚Ä¢ Cant.: <strong><t t-esc="state.qty"/></strong></t>
              </div>
            </div>
          </t>

          <!-- PASO 3: INGREDIENTES -->
          <t t-if="state.step === 'components'">
            <div class="o_smrp_container o_smrp_section">
              <h2>Ingredientes</h2>
              
              <!-- MODO B√öSQUEDA -->
              <t t-if="!state.editingComponent">
                <div class="o_smrp_box">
                  <div class="o_smrp_name">Agregar ingrediente</div>
                  <div class="o_smrp_row">
                    <input class="o_smrp_input o_smrp_input--xl" type="text" placeholder="Buscar‚Ä¶"
                           t-model="state.compSearchQuery" t-on-input="() => this.searchComponents()"/>
                    <input class="o_smrp_input o_smrp_input--xl" type="number" min="0" step="0.0001"
                           t-model="state.newCompQty" placeholder="Cantidad"/>
                  </div>
                  <div class="o_smrp_cards o_smrp_cards--center">
                    <t t-foreach="state.compSearchResults" t-as="p" t-key="p.id">
                      <div class="o_smrp_card selectable" t-on-click="() => this.addComponentFromSearch(p)">
                        <div class="o_smrp_card_icon">‚ûï</div>
                        <div class="o_smrp_card_title"><t t-esc="p.name"/></div>
                        <div class="o_smrp_card_sub"><t t-esc="p.uom_name"/></div>
                      </div>
                    </t>
                  </div>
                </div>
              </t>

              <!-- MODO EDICI√ìN -->
              <t t-if="state.editingComponent &amp;&amp; state.components.length">
                <div class="o_smrp_wizard">
                  <div class="o_smrp_counter">Ingrediente <t t-esc="state.compIndex + 1"/> de <t t-esc="state.components.length"/></div>
                  <t t-set="c" t-value="state.components[state.compIndex]"/>
                  <div class="o_smrp_box o_smrp_box--big">
                    <div class="o_smrp_name"><t t-esc="c.name"/></div>
                    <div class="o_smrp_meta">UM: <t t-esc="c.uom_name"/></div>
                    <div class="o_smrp_row">
                      <label class="o_smrp_label">Cantidad Total</label>
                      <input class="o_smrp_input o_smrp_input--xl" type="number" min="0" step="0.0001"
                             t-att-value="c.qty_required" t-on-input="(ev) => this.updateCurrentQty(ev)"/>
                    </div>
                  </div>
                  <div class="o_smrp_actions o_smrp_actions--sticky">
                    <button class="o_smrp_btn o_smrp_btn--ghost o_smrp_btn--xl" t-on-click="() => this.removeCurrentComponent()">üóëÔ∏è Quitar</button>
                    <button class="o_smrp_btn o_smrp_btn--ghost o_smrp_btn--xl" t-att-disabled="state.compIndex === 0" t-on-click="() => this.prevComponent()">‚Üê Anterior</button>
                    <button class="o_smrp_btn confirm o_smrp_btn--xl" t-on-click="() => this.nextComponent()">
                      <t t-if="state.compIndex &lt; state.components.length - 1">Siguiente ‚Üí</t>
                      <t t-else="">‚úì Listo</t>
                    </button>
                  </div>
                </div>
              </t>

              <!-- ACTIONS BAR -->
              <div class="o_smrp_actions o_smrp_actions--sticky" t-if="state.components.length">
                 <button class="o_smrp_btn o_smrp_btn--ghost" t-on-click="() => this.backToProduct()">‚Üê Volver</button>
                 <button class="o_smrp_btn o_smrp_btn--ghost" t-on-click="() => this.reviewComponents()">üìù Revisar</button>
                 <button class="o_smrp_btn confirm o_smrp_btn--xl" t-on-click="() => this.continueToLots()">‚úì Ir a Lotes</button>
              </div>
            </div>
          </t>

          <!-- PASO 4: LOTES MULTI-SELECCION -->
          <t t-if="state.step === 'lots'">
            <div class="o_smrp_container o_smrp_section">
              <h2>Selecci√≥n de Lotes</h2>
              <t t-if="state.components.length">
                <div class="o_smrp_wizard">
                  <t t-set="c" t-value="state.components[state.compIndex]"/>
                  <div class="o_smrp_counter">
                      Ingrediente <t t-esc="state.compIndex + 1"/> de <t t-esc="state.components.length"/>
                  </div>
                  
                  <div class="o_smrp_box o_smrp_box--big">
                    <div class="o_smrp_header_flex">
                        <div class="o_smrp_name"><t t-esc="c.name"/></div>
                        <div class="o_smrp_progress_text">
                            <t t-set="assigned" t-value="this.getAssignedTotal(c.product_id)"/>
                            Asignado: <strong><t t-esc="assigned.toFixed(2)"/></strong> / <t t-esc="c.qty_required"/> <t t-esc="c.uom_name"/>
                        </div>
                    </div>
                    <!-- Barra de progreso -->
                    <div class="o_smrp_progress_bar">
                        <t t-set="assigned" t-value="this.getAssignedTotal(c.product_id)"/>
                        <div class="o_smrp_progress_fill" 
                             t-att-style="'width:' + Math.min((assigned / (c.qty_required || 1))*100, 100) + '%'"></div>
                    </div>

                    <div class="o_smrp_lots">
                      <t t-foreach="state.lots" t-as="l" t-key="l.id">
                        <!-- Tarjeta con Input -->
                        <div class="o_smrp_lot_input_card" t-att-class="{'active': this.getLotAssignedValue(c.product_id, l.id) > 0}">
                          <div class="head">
                             <div class="name"><t t-esc="l.name"/></div>
                             <div class="avail">Disp: <t t-esc="l.qty_available"/></div>
                          </div>
                          <div class="input-area">
                             <label>Usar:</label>
                             <input type="number" min="0" step="0.001" 
                                    class="o_smrp_input_small"
                                    t-att-value="this.getLotAssignedValue(c.product_id, l.id)"
                                    t-on-change="(ev) => this.updateLotAssignment(l.id, ev.target.value)"/>
                          </div>
                        </div>
                      </t>
                      <t t-if="!state.lots.length">
                        <div class="o_smrp_empty o_smrp_empty--block">Sin lotes disponibles.</div>
                      </t>
                    </div>
                  </div>

                  <div class="o_smrp_actions o_smrp_actions--sticky">
                    <button class="o_smrp_btn o_smrp_btn--ghost o_smrp_btn--xl" t-on-click="() => this.prevLotStep()">
                      <t t-if="state.compIndex === 0">‚Üê Volver a Ingredientes</t>
                      <t t-else="">‚Üê Anterior</t>
                    </button>
                    <button class="o_smrp_btn confirm o_smrp_btn--xl" t-on-click="() => this.nextLotStep()">
                      <t t-if="state.compIndex &lt; state.components.length - 1">Siguiente Ingrediente ‚Üí</t>
                      <t t-else="">‚úì Crear Orden</t>
                    </button>
                  </div>
                </div>
              </t>
            </div>
          </t>

          <!-- PASO 5: DONE -->
          <t t-if="state.step === 'done'">
            <div class="o_smrp_container o_smrp_section o_smrp_done">
              <div class="o_smrp_done_icon">üéâ</div>
              <h2>¬°Orden creada!</h2>
              <div class="o_smrp_box">
                  <div>Orden: <strong><t t-esc="state.resultMoName"/></strong></div>
                  <div>La producci√≥n ha sido registrada correctamente.</div>
              </div>
              <div class="o_smrp_actions o_smrp_actions--center">
                <button class="o_smrp_btn confirm o_smrp_btn--xl" t-on-click="() => this.resetWizard()">Crear nueva orden</button>
              </div>
            </div>
          </t>
        </t>

        <!-- ========== VISTA LISTA / DETALLE (Sin cambios mayores, solo mostrar origen) ========== -->
        <t t-if="state.view === 'list'">
          <div class="o_smrp_container o_smrp_section">
            <h2>Mis √≥rdenes</h2>
            <div class="o_smrp_list">
              <t t-foreach="state.myProductions" t-as="mo" t-key="mo.id">
                <div class="o_smrp_list_item" t-on-click="() => this.loadMoDetail(mo.id)">
                  <div class="o_smrp_list_icon">üì¶</div>
                  <div class="o_smrp_list_content">
                    <div class="o_smrp_list_title"><t t-esc="mo.name"/></div>
                    <div class="o_smrp_list_meta">
                        <t t-esc="mo.product_name"/> (<t t-esc="mo.product_qty"/> <t t-esc="mo.uom_name"/>)
                    </div>
                  </div>
                  <div class="o_smrp_list_badge" t-att-class="this.getStateClass(mo.state)">
                    <t t-esc="this.getStateLabel(mo.state)"/>
                  </div>
                </div>
              </t>
            </div>
            <div class="o_smrp_empty" t-if="!state.myProductions.length">No tienes √≥rdenes.</div>
          </div>
        </t>

        <t t-if="state.view === 'detail' &amp;&amp; state.moDetail">
          <div class="o_smrp_container o_smrp_section">
            <div class="o_smrp_actions o_smrp_actions--center">
              <button class="o_smrp_btn o_smrp_btn--ghost" t-on-click="() => this.backToList()">‚Üê Volver a lista</button>
            </div>
            <h2><t t-esc="state.moDetail.name"/></h2>
            <div class="o_smrp_box o_smrp_box--big">
                <div class="o_smrp_detail_row">
                    <span class="o_smrp_detail_label">Origen:</span>
                    <strong><t t-esc="state.moDetail.origin || 'N/A'"/></strong>
                </div>
                <div class="o_smrp_detail_row">
                    <span class="o_smrp_detail_label">Producto:</span>
                    <strong><t t-esc="state.moDetail.product_name"/></strong>
                </div>
                <div class="o_smrp_detail_row">
                    <span class="o_smrp_detail_label">Cantidad:</span>
                    <strong><t t-esc="state.moDetail.product_qty"/></strong> <t t-esc="state.moDetail.uom_name"/>
                </div>
                <!-- ... resto del detalle ... -->
            </div>
             <h2>Ingredientes Utilizados</h2>
            <div class="o_smrp_list">
              <t t-foreach="state.moDetail.components" t-as="comp" t-key="comp_index">
                <div class="o_smrp_list_item">
                  <div class="o_smrp_list_content">
                    <div class="o_smrp_list_title"><t t-esc="comp.product_name"/></div>
                    <div class="o_smrp_list_meta">
                      Req: <strong><t t-esc="comp.qty_required"/></strong> | Usado: <strong><t t-esc="comp.qty_done"/></strong>
                      <br/>Lotes: <span style="color:#2737BE;"><t t-esc="comp.lot_name"/></span>
                    </div>
                  </div>
                </div>
              </t>
            </div>
          </div>
        </t>

      </div>
    </div>
  </t>
</templates>